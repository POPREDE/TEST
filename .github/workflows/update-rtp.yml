name: Update RTP JSON

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Generate RTP JSON
        run: |
          node << 'EOF'
          const fs = require("fs");

          function shuffle(arr) {
              for (let i = arr.length - 1; i > 0; i--) {
                  const j = Math.floor(Math.random() * (i + 1));
                  [arr[i], arr[j]] = [arr[j], arr[i]];
              }
              return arr;
          }

          function rand(min, max) {
              return parseFloat((Math.random() * (max - min) + min).toFixed(1));
          }

          function generateRTP(totalGames) {
              let result = [];

              const above90 = Math.floor(Math.random() * 3) + 3; // 3–5
              for (let i = 0; i < above90; i++) {
                  result.push(rand(90.0, 99.9));
              }

              const under70 = Math.floor(Math.random() * 6) + 10; // 10–15
              for (let i = 0; i < under70; i++) {
                  result.push(rand(50.0, 69.9));
              }

              while (result.length < totalGames) {
                  result.push(rand(70.0, 89.9));
              }

              return shuffle(result);
          }

          const total_pg = 200;      
          const total_prag = 200;    

          const newData = {
              generated_at: new Date().toISOString(),
              provider: {
                  PG: generateRTP(total_pg),
                  PRAGMATIC: generateRTP(total_prag)
              }
          };

          fs.writeFileSync("rtp.json", JSON.stringify(newData, null, 2));
          EOF

      - name: Commit file
        run: |
          git config --global user.name  "github-actions"
          git config --global user.email "actions@github.com"
          git add rtp.json
          git commit -m "Auto update RTP" || echo "No changes"
          git push
