name: POPREDE RTP Auto Generator SUPER DYNAMIC V4.5

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-node@v3
      with:
        node-version: "18"

    # ================================================================
    # DOWNLOAD CSV
    # ================================================================
    - name: Download Games CSV
      run: |
        curl -L -o games.csv \
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7pX1gQOWmhwR9ecnt59QUS7L-T5XBdDuA_dDwfag3BMz8voU3CbIbfTpq5pdtmYc67Wh3-FC17VUQ/pub?gid=0&single=true&output=tsv"

    # ================================================================
    # GENERATE RTP V4.5 SUPER DYNAMIC
    # ================================================================
    - name: Generate RTP JSON
      run: |
        node << 'EOF'
        const fs = require("fs");

        // ============================================================
        // 1. Load TSV (Google Sheets auto uses TAB)
        // ============================================================
        const raw = fs.readFileSync("games.csv","utf8")
          .trim()
          .split("\n")
          .map(r => r.split("\t"));

        const head = raw.shift().map(x=>x.trim());
        const rows = raw.map(r=>{
          let o={};
          r.forEach((v,i)=>o[head[i]] = v.trim());
          return o;
        });

        // ============================================================
        // 2. Provider Detection
        // ============================================================
        function detect(p){
          p = (p||"").toLowerCase();
          if(p.startsWith("pg")) return "PG";
          if(p.startsWith("prag")) return "PRAGMATIC";
          return null;
        }

        const PG  = rows.filter(r=>detect(r.provider)==="PG");
        const PRG = rows.filter(r=>detect(r.provider)==="PRAGMATIC");

        // ============================================================
        // 3. Helper RNG
        // ============================================================
        const rand = (a,b)=> Number((Math.random()*(b-a)+a).toFixed(1));

        // ============================================================
        // 4. Trend Engine (Daily)
        // ============================================================
        const today = new Date().toISOString().split("T")[0];
        const dir = `rtp-history/${today}`;
        const trendFile = `${dir}/trend.json`;
        fs.mkdirSync(dir,{recursive:true});

        let trend="normal";
        if(!fs.existsSync(trendFile)){
          const pick = ["up","down","normal"];
          trend = pick[Math.floor(Math.random()*pick.length)];
          fs.writeFileSync(trendFile, JSON.stringify({trend}));
        } else {
          trend = JSON.parse(fs.readFileSync(trendFile)).trend;
        }

        // ============================================================
        // 5. NATURAL DISTRIBUTION ENGINE V4.5
        // ============================================================
        function generateNatural(count){
          let out = [];
          const high = Math.min(6, count);
          const low  = Math.min(15, count-high);

          // HIGH
          for(let i=0;i<high;i++){
            let base = trend==="up" ? rand(93,99.9) : rand(90,96);
            out.push(base);
          }

          // LOW
          for(let i=0;i<low;i++){
            let base = trend==="down" ? rand(50,63) : rand(55,70);
            out.push(base);
          }

          // MID
          while(out.length < count){
            if(trend==="down") out.push(rand(63,82));
            else if(trend==="up") out.push(rand(78,93));
            else out.push(rand(70,89));
          }

          out = out.sort(()=>Math.random()-0.5);

          // Ultra-high control: max ⭐2⭐
          let ultra = out.filter(v=>v>=97);
          if(ultra.length>2){
            // scale down excess
            for(let i=2;i<ultra.length;i++){
              let idx = out.indexOf(ultra[i]);
              out[idx] = rand(90,95);
            }
          }

          return out.map(v=>Number(v.toFixed(1)));
        }

        // ============================================================
        // 6. Brazil Time Reset
        // ============================================================
        const now = new Date();
        const hourBR = (now.getUTCHours() - 3 + 24)%24;

        let newPG, newPRG;

        // ============================================================
        // 7. HARD RESET DAILY
        // ============================================================
        if(hourBR === 0){
          newPG  = generateNatural(PG.length);
          newPRG = generateNatural(PRG.length);
        }
        else {
          // ============================================================
          // 8. SOFT UPDATE SUPER-DYNAMIC
          // ============================================================
          let old = {provider:{PG:[],PRAGMATIC:[]}};
          try{ old = JSON.parse(fs.readFileSync("rtp.json")); } catch{}

          function evolve(oldArr){
            return oldArr.map(v=>{
              if(v===undefined) v = rand(70,90);

              let change = 0;

              // Small fluctuations
              change += rand(-1.2,1.2);

              // Random mid fluctuation (20% chance)
              if(Math.random()<0.20)
                change += rand(-2,2);

              // Spike (10% chance)
              if(Math.random()<0.10)
                change += rand(2,4);

              // Overheat control: if over 97 drop
              if(v>97)
                change += rand(-3,-1);

              // Always clamp
              let x = v + change;
              return Number(Math.max(50, Math.min(99.9,x)).toFixed(1));
            });
          }

          newPG  = evolve(old.provider.PG  ?? []);
          newPRG = evolve(old.provider.PRAGMATIC ?? []);
        }

        // ============================================================
        // 9. FINAL SAVE + NOISE INJECTION
        // ============================================================
        const out = {
          provider:{
            PG: newPG,
            PRAGMATIC: newPRG
          },
          noise: Math.random() // anti-cache
        };

        fs.writeFileSync("rtp.json", JSON.stringify(out,null,2));

        // history
        const hh = String(now.getHours()).padStart(2,"0");
        const mm = String(now.getMinutes()).padStart(2,"0");

        fs.writeFileSync(
          `${dir}/${hh}-${mm}.json`,
          JSON.stringify(out,null,2)
        );

        EOF

    # ============================================================
    # PUSH UPDATE
    # ============================================================
    - name: Push Updates
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add rtp.json rtp-history/
        git commit -m "SUPER DYNAMIC RTP V4.5 Update" || echo "No changes"
        git push
