name: POPREDE RTP Auto Generator V4 FULL DYNAMIC

on:
  schedule:
    - cron: "*/5 * * * *"     # Update RTP setiap 5 menit
    - cron: "*/2 * * * *"     # Turbo Keep Alive
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-node@v3
      with:
        node-version: 18

    # Keep GitHub thinking repo is VERY ACTIVE
    - name: Turbo Activity
      run: |
        echo "$(date)" > .alive
        git add .alive
        git commit -m "alive" || true

    - name: Download Games CSV
      run: |
        curl -L -o games.csv \
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7pX1gQOWmhwR9ecnt59QUS7L-T5XBdDuA_dDwfag3BMz8voU3CbIbfTpq5pdtmYc67Wh3-FC17VUQ/pub?gid=0&single=true&output=csv"

    - name: Generate RTP JSON V4 FULL DYNAMIC
      run: |
        node << 'EOF'
        const fs = require("fs");

        // Load CSV
        const raw = fs.readFileSync("games.csv","utf8")
          .trim()
          .split("\n")
          .map(r => r.split(/[\t,;]+/));

        const head = raw.shift();
        const rows = raw.map(r=>{
          let o={};
          r.forEach((v,i)=>o[head[i]] = (v||"").trim());
          return o;
        });

        // Detect provider
        function detect(p){
          p=(p||"").toLowerCase();
          if(p.includes("pg")) return "PG";
          if(p.includes("prag")) return "PRAGMATIC";
          return "OTHER";
        }

        const PG = rows.filter(x=>detect(x.provider)==="PG");
        const PR = rows.filter(x=>detect(x.provider)==="PRAGMATIC");

        // System time
        const now = new Date();
        const today = now.toISOString().split("T")[0];
        const hourBR = (now.getUTCHours() - 3 + 24) % 24;

        // Load trend
        let trendFile = `rtp-history/${today}/trend.json`;
        let trend="normal";

        if(!fs.existsSync(trendFile)){
          const pick = ["up","down","volatile","steady"];
          trend = pick[Math.floor(Math.random()*pick.length)];
          fs.mkdirSync(`rtp-history/${today}`,{recursive:true});
          fs.writeFileSync(trendFile, JSON.stringify({trend}));
        } else {
          trend = JSON.parse(fs.readFileSync(trendFile)).trend || "steady";
        }

        function r(min,max){return +(Math.random()*(max-min)+min).toFixed(1);}

        // V4 — hyper realistic distribution
        function generateDynamicBase(count, provider){
          let arr=[];

          let high = Math.min(6,count);
          let ultra = Math.min(2,count);
          let low = Math.min(15,count);

          // Ultra High
          for(let i=0;i<ultra;i++)
            arr.push(r(97,99.9));

          // High
          for(let i=0;i<high-ultra;i++){
            if(provider==="PG") arr.push(r(90,97));
            else arr.push(r(88,97.5));
          }

          // Low
          for(let i=0;i<low;i++){
            if(provider==="PG") arr.push(r(55,68));
            else arr.push(r(50,65));
          }

          // Middle realistic band
          while(arr.length<count){
            if(provider==="PG") arr.push(r(70,89));
            else arr.push(r(65,92));
          }

          return arr.sort(()=>Math.random()-0.5);
        }

        // Load old RTP
        let old={provider:{PG:[],PRAGMATIC:[]}};
        try{ old = JSON.parse(fs.readFileSync("rtp.json")); }catch{}

        // V4 Soft update engine (full dynamic)
        function dynamicUpdate(oldArr, provider){
          return oldArr.map((v,i)=>{
            let val = v;

            // micro adjustments
            val += (Math.random()*0.6 - 0.3); // ±0.3

            // medium drift
            val += (Math.random()*1.8 - 0.9); // ±0.9

            // random spike (10%)
            if(Math.random()<0.10)
              val += (Math.random()*8 - 4); // ±4

            // volatility different per provider
            if(provider==="PRAGMATIC" && Math.random()<0.25)
              val += (Math.random()*6 - 3);

            // trend effect
            if(trend==="up") val += r(0.2,0.5);
            if(trend==="down") val -= r(0.3,0.6);
            if(trend==="volatile") val += r(-1.5,1.5);

            // heat-cycle (10% chance)
            if(Math.random()<0.10){
              val += r(1,3);
            }

            // cool-cycle (10% chance)
            if(Math.random()<0.10){
              val -= r(1,3);
            }

            // cooldown >97
            if(val >= 97 && Math.random()<0.60){
              val -= r(2,5);
            }

            // auto recovery <60
            if(val < 60 && Math.random()<0.25){
              val += r(1,3);
            }

            // caps
            if(val < 50) val=50;
            if(val > 99.9) val=99.9;

            return +val.toFixed(1);
          });
        }

        let newPG,newPR;

        // Hard reset at Brazil midnight
        if(hourBR===0){
          newPG = generateDynamicBase(PG.length,"PG");
          newPR = generateDynamicBase(PR.length,"PRAGMATIC");
        } else {
          newPG = dynamicUpdate(
            old.provider.PG.length ? old.provider.PG : generateDynamicBase(PG.length,"PG"),
            "PG"
          );
          newPR = dynamicUpdate(
            old.provider.PRAGMATIC.length ? old.provider.PRAGMATIC : generateDynamicBase(PR.length,"PRAGMATIC"),
            "PRAGMATIC"
          );
        }

        const output = {
          provider:{
            PG: newPG,
            PRAGMATIC: newPR
          }
        };

        fs.writeFileSync("rtp.json", JSON.stringify(output,null,2));
        fs.appendFileSync("rtp.json"," "); // force file change

        const hh = String(now.getHours()).padStart(2,'0');
        const mm = String(now.getMinutes()).padStart(2,'0');

        fs.mkdirSync(`rtp-history/${today}`,{recursive:true});
        fs.writeFileSync(
          `rtp-history/${today}/${hh}-${mm}.json`,
          JSON.stringify(output,null,2)
        );

        EOF

    - name: Push Updates
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add -A
        git commit -m "RTP V4 dynamic update" --allow-empty
        git push
