name: Advanced RTP Generator (Level 2)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-node@v3
      with:
        node-version: "18"

    - name: Download Games CSV
      run: |
        curl -L -o games.csv \
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7pX1gQOWmhwR9ecnt59QUS7L-T5XBdDuA_dDwfag3BMz8voU3CbIbfTpq5pdtmYc67Wh3-FC17VUQ/pub?gid=0&single=true&output=csv"

    - name: Generate Advanced RTP JSON
      run: |
        node << 'EOF'
        const fs = require("fs");

        // LOAD CSV
        const raw = fs.readFileSync("games.csv","utf8")
          .trim()
          .split("\n")
          .map(r=>r.split(","));

        const head = raw.shift();
        const rows = raw.map(r=>{
          let o={};
          r.forEach((v,i)=>o[head[i]]=v.trim());
          return o;
        });

        const PG_count = rows.filter(x=>x.provider==="PG").length;
        const PRAG_count = rows.filter(x=>x.provider==="PRAGMATIC").length;

        // TREND ENGINE (dipilih setiap hari)
        const today = new Date().toISOString().split("T")[0];
        const trendFile = `rtp-history/${today}/trend.json`;

        let trend="normal";
        if(!fs.existsSync(trendFile)){
          const all = ["up","down","normal"];
          trend = all[Math.floor(Math.random()*all.length)];

          fs.mkdirSync(`rtp-history/${today}`,{recursive:true});
          fs.writeFileSync(trendFile, JSON.stringify({trend}));
        } else {
          const data = JSON.parse(fs.readFileSync(trendFile));
          trend = data.trend;
        }

        function baseRandom(min,max){
          return +(Math.random()*(max-min)+min).toFixed(1);
        }

        // DISTRIBUSI LEVEL 2 (lebih natural)
        function makeRTP(count){
          let arr = [];

          let high = Math.min(5,count);
          let low  = Math.min(15,count-high);

          // Make high group
          for(let i=0;i<high;i++){
            if(trend==="up") arr.push(baseRandom(93,99.9));
            else arr.push(baseRandom(90,96));
          }

          // Make low group
          for(let i=0;i<low;i++){
            if(trend==="down") arr.push(baseRandom(50,66));
            else arr.push(baseRandom(55,70));
          }

          // Middle group
          while(arr.length<count){
            if(trend==="up") arr.push(baseRandom(78,93));
            else if(trend==="down") arr.push(baseRandom(65,82));
            else arr.push(baseRandom(70,90));
          }

          // Shuffle
          arr.sort(()=>Math.random()-0.5);
          return arr;
        }

        // DAILY RESET (jam 00 Brasil)
        const now = new Date();
        const hour = now.getUTCHours() - 3; // Brasil = UTC-3

        let rtpPG, rtpPRAG;

        if(hour<=0){ 
          // FULL RESET
          rtpPG = makeRTP(PG_count);
          rtpPRAG = makeRTP(PRAG_count);
        } else {
          // SOFT UPDATE
          const old = JSON.parse(fs.readFileSync("rtp.json"));
          rtpPG = old.provider.PG.map(v=>{
            let change = baseRandom(-2,2);
            let n = v + change;
            if(n>99.9) n=99.9;
            if(n<50) n=50;
            return +n.toFixed(1);
          });

          rtpPRAG = old.provider.PRAGMATIC.map(v=>{
            let change = baseRandom(-2,2);
            let n = v + change;
            if(n>99.9) n=99.9;
            if(n<50) n=50;
            return +n.toFixed(1);
          });
        }

        const output = {
          provider:{
            PG: rtpPG,
            PRAGMATIC: rtpPRAG
          }
        };

        fs.writeFileSync("rtp.json", JSON.stringify(output,null,2));

        // SAVE HISTORY
        const t = new Date();
        const hh = String(t.getHours()).padStart(2,'0');
        const mm = String(t.getMinutes()).padStart(2,'0');

        fs.writeFileSync(
          `rtp-history/${today}/${hh}-${mm}.json`,
          JSON.stringify(output,null,2)
        );

        EOF

    - name: Push to Repo
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add rtp.json rtp-history/
        git commit -m "Advanced RTP Update" || echo "nothing to commit"
        git push
