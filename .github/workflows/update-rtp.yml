name: Generate RTP JSON

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Install Node
      uses: actions/setup-node@v3
      with:
        node-version: "18"

    - name: Generate RTP JSON
      run: |
        curl -L -o games.csv "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7pX1gQOWmhwR9ecnt59QUS7L-T5XBdDuA_dDwfag3BMz8voU3CbIbfTpq5pdtmYc67Wh3-FC17VUQ/pub?gid=0&single=true&output=csv"

        node << 'EOF'
        const fs = require("fs");

        const csv = fs.readFileSync("games.csv", "utf8")
          .trim()
          .split("\n")
          .map(r => r.split(","));

        const head = csv.shift();
        const rows = csv.map(r => {
          let o = {};
          r.forEach((v,i)=> o[head[i]] = v.trim());
          return o;
        });

        const pgCount = rows.filter(x=>x.provider==="PG").length;
        const pragCount = rows.filter(x=>x.provider==="PRAGMATIC").length;

        function random(min,max){return +(Math.random()*(max-min)+min).toFixed(1)}

        function makeRTP(total){
          let arr=[];
          let hi = Math.min(5,total);
          let lo = Math.min(15,total-hi);

          for(let i=0;i<hi;i++) arr.push(random(90,99.9));
          for(let i=0;i<lo;i++) arr.push(random(50,70));
          while(arr.length<total) arr.push(random(70,90));

          return arr.sort(()=>Math.random()-0.5);
        }

        const out={
          provider:{
            PG: makeRTP(pgCount),
            PRAGMATIC: makeRTP(pragCount)
          }
        };

        fs.writeFileSync("rtp.json",JSON.stringify(out,null,2));
        EOF

    - name: Push Changes
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "github-actions"
        git add rtp.json
        git commit -m "Auto update RTP" || true
        git push
