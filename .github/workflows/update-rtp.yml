name: POPREDE RTP Auto Generator TURBO

on:
  schedule:
    - cron: "*/5 * * * *"     # Update RTP setiap 5 menit
    - cron: "*/2 * * * *"     # Force Activity tiap 2 menit (Turbo Mode)
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v3

    - uses: actions/setup-node@v3
      with:
        node-version: "18"

    # -----------------------------------------------------
    # GITHUB PING â€” menjaga repo dianggap aktif
    # -----------------------------------------------------
    - name: GitHub Activity Ping
      run: |
        curl -I https://github.com/POPREDE/TEST > /dev/null 2>&1 || true

    # -----------------------------------------------------
    # FORCE ACTIVITY COMMIT (TURBO MODE)
    # -----------------------------------------------------
    - name: Force Repo Alive (Turbo Mode)
      run: |
        echo "$(date)" > .alive
        git add .alive
        git commit -m "keepalive-turbo" || echo "no changes"

    # -----------------------------------------------------
    # DOWNLOAD CSV GAME LIST
    # -----------------------------------------------------
    - name: Download Games CSV
      run: |
        curl -L -o games.csv \
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7pX1gQOWmhwR9ecnt59QUS7L-T5XBdDuA_dDwfag3BMz8voU3CbIbfTpq5pdtmYc67Wh3-FC17VUQ/pub?gid=0&single=true&output=csv"

    # -----------------------------------------------------
    # GENERATE RTP LOGIC
    # -----------------------------------------------------
    - name: Generate RTP JSON + Save History
      run: |
        node << 'EOF'
        const fs = require("fs");

        const raw = fs.readFileSync("games.csv","utf8")
          .trim()
          .split("\n")
          .map(r => r.split(/[\t,;]+/));

        const head = raw.shift();
        const rows = raw.map(r=>{
          let o={};
          r.forEach((v,i)=>o[head[i]] = v.trim());
          return o;
        });

        function detectProvider(p){
          const x = (p||"").toLowerCase();
          if(x.includes("pg")) return "PG";
          if(x.includes("prag")) return "PRAGMATIC";
          return "OTHER";
        }

        const PG_list   = rows.filter(x => detectProvider(x.provider)==="PG");
        const PRAG_list = rows.filter(x => detectProvider(x.provider)==="PRAGMATIC");

        const PG_count  = PG_list.length;
        const PRAG_count= PRAG_list.length;

        const today = new Date().toISOString().split("T")[0];
        const trendFile = `rtp-history/${today}/trend.json`;

        let trend = "normal";

        if(!fs.existsSync(trendFile)){
          const pick = ["up","down","normal"];
          trend = pick[Math.floor(Math.random()*pick.length)];

          fs.mkdirSync(`rtp-history/${today}`,{recursive:true});
          fs.writeFileSync(trendFile, JSON.stringify({trend}));
        } else {
          trend = JSON.parse(fs.readFileSync(trendFile)).trend || "normal";
        }

        function rand(min,max){
          return +(Math.random()*(max-min)+min).toFixed(1);
        }

        function generateRTP(count){
          let arr=[];
          const hi=Math.min(5,count);
          const lo=Math.min(15,count-hi);

          for(let i=0;i<hi;i++){
            if(trend==="up") arr.push(rand(93,99.9));
            else arr.push(rand(90,96));
          }

          for(let i=0;i<lo;i++){
            if(trend==="down") arr.push(rand(50,65));
            else arr.push(rand(55,70));
          }

          while(arr.length<count){
            if(trend==="up") arr.push(rand(78,93));
            else if(trend==="down") arr.push(rand(63,82));
            else arr.push(rand(70,90));
          }

          return arr.sort(()=>Math.random()-0.5);
        }

        const now = new Date();
        const hourBR = (now.getUTCHours()-3+24)%24;

        let rtpPG, rtpPRAG;

        let old={provider:{PG:[],PRAGMATIC:[]}};
        try{
          old = JSON.parse(fs.readFileSync("rtp.json"));
        }catch{}

        if(hourBR === 0){
          rtpPG   = generateRTP(PG_count);
          rtpPRAG = generateRTP(PRAG_count);
        } else {
          rtpPG = PG_list.map((_,i)=>{
            let oldV = old.provider.PG[i] ?? rand(70,90);
            return Math.max(50,Math.min(99.9, oldV + rand(-2,2)));
          });

          rtpPRAG = PRAG_list.map((_,i)=>{
            let oldV = old.provider.PRAGMATIC[i] ?? rand(70,90);
            return Math.max(50,Math.min(99.9, oldV + rand(-2,2)));
          });
        }

        const output = {
          provider:{
            PG: rtpPG,
            PRAGMATIC: rtpPRAG
          }
        };

        fs.writeFileSync("rtp.json", JSON.stringify(output,null,2));

        const hh = String(now.getHours()).padStart(2,"0");
        const mm = String(now.getMinutes()).padStart(2,"0");

        const historyDir = `rtp-history/${today}`;
        fs.mkdirSync(historyDir,{recursive:true});

        fs.writeFileSync(
          `${historyDir}/${hh}-${mm}.json`,
          JSON.stringify(output,null,2)
        );

        EOF

    # -----------------------------------------------------
    # PUSH DATA
    # -----------------------------------------------------
    - name: Push Updates
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add .
        git commit -m "Auto RTP + Turbo Mode" || echo "no changes"
        git push
